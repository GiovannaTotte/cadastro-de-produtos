<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Produtos — web_03mb</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
  <header>
  <a href="/" class="logo">Listfy.</a>
  <nav class="nav-row">
    <a href="index.html">Home</a>
    <a href="products.html">Produtos</a>
    <a href="add.html">Cadastrar</a>
  </nav>
</header>

  <main>
    <h2 style="margin-top:0">Produtos</h2>
    <section id="list" class="grid"></section>
  </main>
  </div>

<script>
  async function load() {
    try {
      const list = document.getElementById('list');
      list.textContent = 'Carregando...';
      
      const res = await fetch('/api/products');
      if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
      
      const data = await res.json();
      
      if (!data || data.length === 0) {
        list.innerHTML = '<div class="empty">Nenhum produto cadastrado.</div>';
        return;
      }

      list.innerHTML = '';
      data.forEach(p => {
        const card = document.createElement('div');
        card.className = 'card';

        const title = document.createElement('h3');
        title.textContent = p.nome || p.name || 'Sem nome';

        const desc = document.createElement('div');
        desc.className = 'muted';
        desc.textContent = `ID: ${p.id} • ${p.create_time || p.created_at || ''}`;

        const price = document.createElement('div');
        price.className = 'price';
        price.textContent = 'R$ ' + Number(p.preco || p.price || 0).toFixed(2);

        // --- BOTAO DE DELETAR ---
        const btnDelete = document.createElement('button');
        btnDelete.textContent = 'Excluir';
        btnDelete.className = 'btn-delete';
        btnDelete.style.marginTop = '10px';
        // passa o elemento do card para remoção imediata no frontend
        btnDelete.onclick = () => deleteProduct(p.id, card);
        // ------------------------

        card.appendChild(title);
        card.appendChild(desc);
        card.appendChild(price);
        card.appendChild(btnDelete);
        list.appendChild(card);
      });
    } catch (e) {
      console.error('Erro ao carregar produtos:', e);
      document.getElementById('list').textContent = 'Erro ao carregar: ' + e.message;
    }
  }

  async function deleteProduct(id, cardElement) {
    if (!confirm('Tem certeza que deseja excluir este produto?')) return;

    try {
      const res = await fetch(`/api/products/${id}`, {
        method: 'DELETE'
      });

      if (res.ok) {
        // Remoção otimista: remove só o card alterado sem recarregar tudo
        if (cardElement && cardElement.parentNode) cardElement.parentNode.removeChild(cardElement);
        else load();
      } else {
        const err = await res.json().catch(() => ({ error: 'Erro desconhecido' }));
        alert('Erro ao deletar: ' + (err.error || 'Desconhecido'));
      }
    } catch (e) {
      console.error(e);
      alert('Erro na comunicação com o servidor: ' + e.message);
    }
  }

  // Chamar load() quando DOM estiver pronto
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', load);
  } else {
    load();
  }
</script>
</body>
</html>